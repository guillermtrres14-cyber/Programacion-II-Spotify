<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Spotify ML Dashboard 2024</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="page">
    <!-- NAVBAR -->
    <header class="navbar">
        <div class="logo">
            <div class="logo-icon">ML</div>
            <div>
                <div class="logo-text-main">Spotify ML Dashboard</div>
                <div class="logo-text-sub">Proyecto de Machine Learning – 2024</div>
            </div>
        </div>
        <nav class="nav-links">
            <a href="{{ url_for('index') }}">Inicio</a>
            <a href="{{ url_for('vista_dataset') }}">Dataset</a>
            <a href="#" class="nav-pill">Demo local</a>
        </nav>
    </header>

    {% set hay_regresion = results is defined and results and results.ok %}
    {% set hay_arbol = metrics is defined and metrics and metrics.ok and selected_model == "Árbol de Decisión" %}

    <!-- HERO -->
    <section class="hero">
        <div class="hero-text">
            <div class="eyebrow">
                <span></span>
                <div>Análisis global de streaming en Spotify</div>
            </div>

            <h1 class="hero-title">
                Predice y agrupa <span class="hero-highlight">streams</span>
                con modelos de Machine Learning.
            </h1>

            <p class="hero-subtitle">
                Esta aplicación ejecuta modelos de <strong>Regresión Lineal</strong>,
                <strong>Árbol de Decisión</strong> y <strong>K-means</strong> sobre el dataset
                <strong>Spotify 2024 Global Streaming</strong> para analizar el comportamiento
                de reproducción en diferentes países y artistas.
            </p>

            <div class="hero-actions">
                <a href="{{ url_for('vista_regresion') }}" class="btn btn-primary">
                    Ejecutar Regresión de Streams
                </a>
                <a href="{{ url_for('vista_dataset') }}" class="btn btn-ghost">
                    Ver muestra del dataset
                </a>
            </div>

            <div class="hero-meta">
                {% if hay_regresion %}
                    Modelo actual: <strong>Regresión Lineal</strong> ·
                    Target: <strong>{{ results.target }}</strong> ·
                    R²: <strong>{{ results.r2 }}</strong>
                {% elif hay_arbol %}
                    Modelo actual: <strong>Árbol de Decisión</strong> ·
                    Target: <strong>{{ metrics.columna_objetivo }}</strong> ·
                    R²: <strong>{{ metrics.R2 }}</strong>
                {% else %}
                    Selecciona uno de los modelos para ver sus métricas en tiempo real.
                {% endif %}
            </div>
        </div>

        <!-- PANEL MÉTRICAS -->
        <aside class="hero-panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">
                        {% if hay_regresion %}
                            Resultados – Regresión Lineal
                        {% elif hay_arbol %}
                            Resultados – Árbol de Decisión
                        {% else %}
                            Resultados del modelo
                        {% endif %}
                    </div>
                    <div class="panel-subtitle">
                        {% if hay_regresion %}
                            Predicción de Total Streams (Millions)
                        {% elif hay_arbol %}
                            {{ metrics.tipo }}
                        {% else %}
                            Aún no se han podido calcular métricas.
                        {% endif %}
                    </div>
                </div>
                <div class="panel-chip">Spotify 2024</div>
            </div>

            {% if hay_regresion %}
                <div class="metrics-grid">
                    <div>
                        <div class="metric-label">R²</div>
                        <div class="metric-value">{{ results.r2 }}</div>
                    </div>
                    <div>
                        <div class="metric-label">MSE</div>
                        <div class="metric-value">{{ results.mse }}</div>
                    </div>
                    <div>
                        <div class="metric-label">MAE</div>
                        <div class="metric-value">{{ results.mae }}</div>
                    </div>
                    <div>
                        <div class="metric-label">Mejor predictor</div>
                        <div class="metric-value">{{ results.best_feature }}</div>
                    </div>
                </div>

                <div class="panel-footer">
                    El modelo se entrenó para predecir
                    <span>{{ results.target }}</span> usando variables numéricas del dataset
                    de Spotify 2024.
                </div>

            {% elif hay_arbol %}
                <div class="metrics-grid">
                    {% if metrics.MAE is defined %}
                    <div>
                        <div class="metric-label">MAE</div>
                        <div class="metric-value">{{ metrics.MAE }}</div>
                    </div>
                    {% endif %}
                    {% if metrics.MSE is defined %}
                    <div>
                        <div class="metric-label">MSE</div>
                        <div class="metric-value">{{ metrics.MSE }}</div>
                    </div>
                    {% endif %}
                    {% if metrics.RMSE is defined %}
                    <div>
                        <div class="metric-label">RMSE</div>
                        <div class="metric-value">{{ metrics.RMSE }}</div>
                    </div>
                    {% endif %}
                    {% if metrics.R2 is defined %}
                    <div>
                        <div class="metric-label">R²</div>
                        <div class="metric-value">{{ metrics.R2 }}</div>
                    </div>
                    {% endif %}
                </div>

                <div class="panel-footer">
                    Modelo entrenado para predecir
                    <span>{{ metrics.columna_objetivo }}</span> usando un Árbol de Decisión
                    sobre variables numéricas del dataset de Spotify 2024.
                </div>

            {% else %}
                <div class="panel-footer">
                    Ejecuta alguno de los modelos para visualizar aquí sus métricas principales
                    (R², MSE, MAE, RMSE, etc.) y entender qué variables explican mejor los streams.
                    {% if results is defined and results and not results.ok %}
                        <br><br>
                        <span style="color:#e74c3c; font-size: 0.9rem;">
                            {{ results.error }}
                        </span>
                    {% elif metrics is defined and metrics and not metrics.ok %}
                        <br><br>
                        <span style="color:#e74c3c; font-size: 0.9rem;">
                            {{ metrics.error }}
                        </span>
                    {% endif %}
                </div>
            {% endif %}
        </aside>
    </section>

    <!-- VISUALIZACIONES REGRESIÓN -->
    {% if hay_regresion %}
    <section class="charts-section">
        <h2 class="section-title">Visualizaciones de la Regresión Lineal</h2>
        <p class="section-subtitle">
            Las siguientes gráficas muestran la relación entre la variable más
            influyente y el objetivo, así como la importancia relativa de las
            variables del modelo.
        </p>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Relación {{ results.best_feature }} vs {{ results.target }}</h3>
                <p class="chart-description">
                    Dispersión de los datos reales y línea de regresión ajustada.
                </p>
                {% if results.images.scatter %}
                    <img
                        src="{{ url_for('static', filename=results.images.scatter) }}"
                        alt="Scatter + línea de regresión"
                        class="chart-image"
                    >
                {% endif %}
            </div>

            <div class="chart-card">
                <h3>Importancia de Variables</h3>
                <p class="chart-description">
                    Importancia (valor absoluto del coeficiente) de cada variable
                    en el modelo de regresión lineal.
                </p>
                {% if results.images.importancia %}
                    <img
                        src="{{ url_for('static', filename=results.images.importancia) }}"
                        alt="Importancia de variables en la regresión"
                        class="chart-image"
                    >
                {% endif %}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- VISUALIZACIONES ÁRBOL DE DECISIÓN -->
    {% if hay_arbol %}
    <section class="charts-section">
        <h2 class="section-title">Visualizaciones del Árbol de Decisión</h2>
        <p class="section-subtitle">
            El Árbol de Decisión permite entender cómo distintas variables explican
            el total de streams. A continuación se muestra el desempeño del modelo
            y la importancia de las variables.
        </p>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Streams reales vs predichos</h3>
                <p class="chart-description">
                    Cada punto representa una observación del conjunto de prueba;
                    la línea roja indica la predicción perfecta.
                </p>
                {% if metrics.images.real_vs_pred %}
                    <img
                        src="{{ url_for('static', filename=metrics.images.real_vs_pred) }}"
                        alt="Árbol de decisión: Real vs Predicho"
                        class="chart-image"
                    >
                {% endif %}
            </div>

            <div class="chart-card">
                <h3>Importancia de variables</h3>
                <p class="chart-description">
                    Variables con mayor peso en las decisiones del árbol.
                </p>
                {% if metrics.images.importancia %}
                    <img
                        src="{{ url_for('static', filename=metrics.images.importancia) }}"
                        alt="Árbol de decisión: Importancia de variables"
                        class="chart-image"
                    >
                {% endif %}
            </div>
        </div>
    </section>
    {% endif %}

    <!-- CARDS DE MODELOS -->
    <section class="cards">
        <article class="card">
            <div class="card-title">Regresión Lineal</div>
            <div class="card-tag">Predicción de streams</div>
            <p class="card-text">
                Estima el valor de <strong>Total Streams (Millions)</strong> usando variables
                numéricas como oyentes mensuales, horas reproducidas y duración media.
            </p>
            <a href="{{ url_for('vista_regresion') }}" class="btn btn-primary">Ver modelo</a>
        </article>

        <article class="card">
            <div class="card-title">Árbol de Decisión</div>
            <div class="card-tag">Modelo interpretable</div>
            <p class="card-text">
                Permite entender qué factores del streaming influyen más en el volumen
                de reproducciones totales por artista o país.
            </p>
            <a href="{{ url_for('vista_arbol') }}" class="btn btn-primary">Ver modelo</a>
        </article>

        <article class="card">
            <div class="card-title">K-means Clustering</div>
            <div class="card-tag">Segmentación de patrones</div>
            <p class="card-text">
                Agrupa canciones o artistas en <strong>clusters</strong> según su comportamiento
                de escucha, oyentes mensuales y tasa de saltos (skips).
            </p>
            <a href="{{ url_for('vista_kmeans') }}" class="btn btn-primary">Ver clusters</a>
        </article>

        <article class="card">
            <div class="card-title">Explorar Dataset</div>
            <div class="card-tag">Spotify 2024 Global</div>
            <p class="card-text">
                Consulta una muestra de las filas originales del dataset: país, artista,
                género, oyentes mensuales y métricas agregadas de streaming.
            </p>
            <a href="{{ url_for('vista_dataset') }}" class="btn btn-primary">Ver datos</a>
        </article>
    </section>
</div>
</body>
</html>